# Generated by Jiffy at <%= Time.now.utc.to_s %>

provider "libvirt" {
    uri = "qemu:///system"
}
<%- if @conf.key?('image') -%>

resource "libvirt_volume" "base-<%= @conf['image']['id'] %>" {
    name = "<%= @conf['image']['id'] %>"
    source = "file://<%= @conf['image']['location'] %>"
    <%- if @conf['image']['pool'] -%>
    pool = "<%= @conf['image']['pool'] %>"
    <%- end -%>
}
<%- end -%>

resource "libvirt_volume" "vol-<%= @conf['name'] %>" {
    name = "vol-<%= @conf['name'] %>"
    <%- if @conf.key?('image') -%>
    base_volume_id = "${libvirt_volume.base-<%= @conf['image']['id'] %>.id}"
    <%- end -%>
    <%- if @conf['pool'] -%>
    pool = "<%= @conf['pool'] %>"
    <%- end -%>
}
<%- if @conf.key?('network') -%>
<%- if @conf['network']['mode'] == 'nat' -%>

resource "libvirt_network" "net-<%= @conf['network']['id'] %>" {
    name = "net-<%= @conf['network']['id'] %>"
    mode = "nat"
    addresses = ["<%= @conf['network']['addresses'] %>"]
}
<%- end -%>
<%- end -%>

resource "libvirt_domain" "<%= @conf['name'] %>" {
    name = "<%= @conf['name'] %>"
    memory = <%= @conf['memory'] %>
    vcpu = <%= @conf['vcpu'] %>
    <%- if @conf.key?('network') -%>

    network_interface {
        <%- if @conf['network']['mode'] == 'bridge' -%>
        bridge = "<%= @conf['network']['bridge'] %>"
        <%- else -%>
        network_name = "net-<%= @conf['network']['id'] %>"
        <%- end -%>
    }
    <%- end -%>

    disk {
        volume_id = "${libvirt_volume.vol-<%= @conf['name'] %>.id}"
    }

    console {
        type = "pty"
        target_port = "0"
        target_type = "serial"
    }
    <%- if @conf.key?('chef') -%>
    connection {
        type = "ssh"
        user = "<%= @conf['image']['user'] %>"
        password = "<%= @conf['image']['password'] %>"
    }
    <%- if @conf['flavor'] == 'dmvpn-hub' || @conf['flavor'] == 'dmvpn-client' -%>

    provisioner "remote-exec" {
        inline = ["mkdir -p /etc/chef"]
    }
    provisioner "file" {
        source = "<%= @conf['dmvpn']['data_bag_secret'] %>"
        destination = "/etc/chef/encrypted_data_bag_secret"
    }
    <%- end -%>
    <%- if @conf['chef']['enabled'] == true || !@conf['chef'].key('enabled') -%>

    provisioner "chef" {
        attributes_json = <<-EOF
            <%= @attributes_json %>
        EOF

        node_name = "<%= @conf['name'] %>"
        <%- @conf['chef']['run_list'].map! { |e| '"' + e + '"' } -%>
        run_list = [<%= @conf['chef']['run_list'].join(', ') %>]
        server_url = "<%= @conf['chef']['server'] %>"
        recreate_client = <%= @conf['chef']['recreate_client'] %>
        skip_install = <%= @conf['chef']['skip_install'] || false %>
        user_name = "<%= @conf['chef']['user_name'] %>"
        user_key = "${file("<%= @conf['chef']['user_key'] %>")}"
        <%- ssl_verify = ':verify_none' if @conf['chef']['ssl_verify'] == false -%>
        <%- ssl_verify ||= ':verify_peer' -%>
        ssl_verify_mode = "<%= ssl_verify %>"
    }
    <%- end -%>
    <%- end -%>
}
